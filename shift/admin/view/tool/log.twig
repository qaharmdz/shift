{% extends 'main.tpl.twig' %}

{% block main_content %}
<div class="uk-container container-content-wrapper">
    <div class="content-header uk-text-center uk-text-left@m">
        <div class="uk-grid" uk-grid>
            <div class="uk-width-expand@m">
                <h1 class="ukt-m-0">{{ shift.lib.language.get('page_title') }}</h1>
            </div>
            <div class="uk-width-auto@m">
                <div class="uk-inline">
                    <button type="button" class="uk-button uk-button-default ukt-px-2 ukt-pl-3">
                        {{ fileinfo.file }} <div class="uk-label uk-label-{{ fileinfo.label }} uk-label-small ukt-ml-3">{{ fileinfo.size }}</div>
                        <span uk-drop-parent-icon></span>
                    </button>
                    <div class="uk-width-{{ partition.width }}" style="max-width:none" uk-dropdown="pos:bottom-right;">
                        <div class="uk-dropdown-grid uk-grid-small uk-child-width-1-{{ partition.column }}@m" uk-grid>
                            {% for column in partition.files %}
                                <div>
                                    <ul class="uk-nav uk-dropdown-nav">
                                        {% for item in column %}
                                            <li><a href="{{ item.url_view }}"><div class="uk-label uk-label-{{ item.label }} uk-label-small uk-label-fixed-width ukt-mr-1"> {{ item.size }}</div> {{ item.file}}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <button type="submit" class="uk-button uk-button-default ukt-px-3 ukt-ml-1" data-log-clear><i class="bi bi-eraser-fill ukt-mr-1"></i> {{ shift.lib.language.get('clear') }}</button>
                <button type="submit" class="uk-button uk-button-secondary ukt-px-3 ukt-ml-3" form="form-log"><i class="bi bi-download ukt-mr-1"></i> {{ shift.lib.language.get('download') }}</button>
                <button type="submit" class="uk-button uk-button-danger ukt-px-3 ukt-ml-1" data-log-delete><i class="bi bi-trash ukt-mr-1"></i> {{ shift.lib.language.get('delete') }}</button>
            </div>
        </div>
    </div>

    {% include '_embed/partial/alerts.tpl.twig' %}

    <div class="content-body uk-card-panel uk-card-body">
        {% if fileinfo.state == 2 %}
            <div class="uk-alert-{{ type }} uk-alert-small" uk-alert>
                <a class="uk-alert-close" uk-close></a>
                <p>{{ log }}</p>
            </div>
        {% else %}
            <pre class="uk-resize-vertical uk-margin-remove logs-content"><code>{{ log }}</code></pre>
        {% endif %}

        <div class="uk-hidden">
            <form id="form-log" action="{{ shift.lib.router.url('tool/log/action', 'submit=download') }}" method="post">
                <input type="text" name="file" value="{{ fileinfo.file }}">
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $('[data-log-clear]').on('click', function(e) {
        e.preventDefault();
        $.fn.shift.confirm({
            title     : shift.i18n.are_you_sure,
            message   : '{{ shift.lib.language.get("confirm_clear")|raw }}',
            onConfirm : function() {
                $('#form-log').attr('action', "{{ shift.lib.router.url('tool/log/action', 'submit=clear')|raw }}").submit();
            }
        });
    });

    $('[data-log-delete]').on('click', function(e) {
        e.preventDefault();
        $.fn.shift.confirm({
            title     : shift.i18n.are_you_sure,
            message   : '{{ shift.lib.language.get("confirm_delete")|raw }}',
            onConfirm : function() {
                $('#form-log').attr('action', "{{ shift.lib.router.url('tool/log/action', 'submit=delete')|raw }}").submit();
            }
        });
    });

    //=== Pretify log messages
    if ($('.logs-content').length) {
        let logs = $('.logs-content code').html().split('\n# ');

        $('.logs-content').hide();
        $('.content-body').append('<pre class="uk-resize-vertical uk-margin-remove logs-content-pretify"><code></code></pre>');

        $.each(logs.reverse(), function(i, log) {
            let _logData  = log.split('|');

            if (_logData[1] != undefined) {
                let _logDate    = _logData[0].trim(),
                    _logType    = _logData[1].trim(),
                    _logMessage = _logData[2].trim(),
                    _logContext = _logData[3].trim(),
                    _logContextObj = JSON.parse(_logContext);
                let html  = '',
                    label = 'uk-label-danger';

                if (_logType == 'Debug') {
                    label = 'uk-background-blue-light';
                } else if (_logType == 'Warning' || _logType == 'Notice') {
                    label = 'uk-label-warning';
                } else if (_logType.search(/exception/i) !== -1) {
                    label = 'uk-background-purple';
                }

                html += '<div class="logs-pretify-item">';
                html += '<b class="logs-date" title="' + _logDate + '">' + formatDate(_logDate) + '</b>';
                html += ' - <span class="uk-label ' + label + ' logs-label">' + _logType + '</span>';
                if (_logMessage) {
                    html += '<div class="ukt-ml-4 ukt-mt-1"><b class="logs-label-error">{{ shift.lib.language.get("message") }}:</b> <span class="logs-error">' + _logMessage.trim() + '</span></div>';
                }
                if ('uri' in _logContextObj) {
                    html += '<div class="ukt-ml-4 ukt-mt-1"><b class="logs-label-context">{{ shift.lib.language.get("context") }}:</b> <span class="logs-context">' + JSON.stringify(_logContextObj, null, 4) + '</span></div>';
                }
                html += '</div>';

                $('.logs-content-pretify code').append(html);
            }
        });
    }
});
</script>
{% endblock %}
